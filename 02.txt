<!DOCTYPE html>
<html>
<head>
  <title>Keycloak HTML Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/keycloak-js@latest/dist/keycloak.min.js"></script>
</head>
<body>
  <h1>Keycloak Protected App</h1>
  <button onclick="keycloak.login()">Login</button>
  <button onclick="keycloak.logout()">Logout</button>
  <button onclick="showToken()">Show Token</button>
  <button onclick="validateToken()">Validate Token</button>
  <div id="output"></div>

  <script>
    const keycloak = new Keycloak({
      url: 'http://localhost:8080/auth',
      realm: 'secure-app',        // Change this to your realm name
      clientId: 'html-client'     // Change this to your client ID
    });

    keycloak.init({ onLoad: 'login-required', checkLoginIframe: true })
      .then(authenticated => {
        document.getElementById('output').innerHTML = authenticated
          ? "Authenticated<br>"
          : "Not Authenticated<br>";

        // Auto-refresh token every 10 seconds
        setInterval(() => {
          keycloak.updateToken(30).catch(() => {
            alert("Token expired or invalid. Logging out...");
            keycloak.logout();
          });
        }, 10000);
      });

    // Display the access token
    function showToken() {
      document.getElementById('output').innerHTML +=
        "<p><b>Access Token:</b><br>" + keycloak.token + "</p>";
    }

    // Validate token with Keycloak userinfo endpoint
    async function validateToken() {
      try {
        const response = await fetch(
          "http://localhost:8080/auth/realms/secure-app/protocol/openid-connect/userinfo",
          { headers: { "Authorization": "Bearer " + keycloak.token } }
        );
        if (!response.ok) throw new Error("Invalid Token or Permissions Error");
        const data = await response.json();
        document.getElementById('output').innerHTML +=
          "<p>Token Valid. User: " + data.preferred_username + "</p>";
      } catch (err) {
        document.getElementById('output').innerHTML +=
          "<p style='color:red;'>" + err.message + "</p>";
      }
    }
  </script>
</body>
</html>
